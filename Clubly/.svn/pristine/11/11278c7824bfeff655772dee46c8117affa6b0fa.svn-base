@model Web.Models.ReservaBungalow
@using Web.Models
@{
    ViewBag.Title = "Reserva de Bungalow";
}

<fieldset>
    <legend>Consultar disponibilidad Bungalow</legend>
    @using (Html.BeginForm()){
        <ul class="col-one">
            <li>
                @(Html.Label("Sede"))
                @(Html.Kendo().DropDownList()
                      .Name("sede")
                      .HtmlAttributes(new { style = "width: 150px" })
                      .DataTextField("nombre")
                      .DataValueField("id")
                      .OptionLabel("--Seleccionar--")
                      .DataSource(source =>
                      {
                          source.Read(read =>
                          {
                              read.Action("ObtenerSedes", "Reservas");
                          });
                      })
                      .Events(ev => ev.Close((@<text>
                          function(e) {
                            cambioMapa(this.value());
                          }</text>)))
            )
            @(Html.TextBox("Sede", null, new { style = "display: none;" }))
            </li><li>
                @(Html.Label("Fecha Inicio"))
                @(Html.Kendo().DatePicker()
                    .Name("finicial") //The name of the datepicker is mandatory. It specifies the "id" attribute of the widget.
                    .HtmlAttributes(new { style = "width:150px" })
                    .Min(DateTime.Today) //Set min date of the datepicker
                    .Max(new DateTime(2015, 12, 31)) //Set min date of the datepicker
                    .Value(DateTime.Today) //Set the value of the datepicker
                    .Events(e => e.Change("startChange"))
                )
            </li><li>
                @(Html.Label("Fecha Final"))
                @(Html.Kendo().DatePicker()
                    .Name("ffinal") //The name of the datepicker is mandatory. It specifies the "id" attribute of the widget.
                    .HtmlAttributes(new { style = "width:150px" })
                    .Min(DateTime.Today) //Set min date of the datepicker
                    .Max(new DateTime(2015, 12, 31)) //Set min date of the datepicker
                    .Value(DateTime.Today) //Set the value of the datepicker
                    .Events(e => e.Change("endChange"))
                )
            </li>
        </ul><ul class="col-two">
            <li>
                <img id="img" src="../../Content/img/SeleccionarSede.png" width="400" height="250" />                  
            </li>
        </ul>
        <div id="botones">
            <input type="button" value="Consultar Disponibilidad" id="cdisponibilidad" onclick="Javascript: cdisponibilidad() "   />
            <input type="button" value="Agregar" id="agregar" onclick="Javascript: AbrirPopup() "   />
            <input type="button" value="Limpiar" id="limpiar" onclick="Javascript: AbrirPopup() "   />
        </div>
        @(Html.TextBox("X", null, new { style = "display: none;" }))
        @(Html.TextBox("Y", null, new { style = "display: none;" }))
    }
</fieldset>

<script>
    function startChange() {
        var endPicker = $("#ffinal").data("kendoDatePicker"),
            startDate = this.value();

        if (startDate) {
            startDate = new Date(startDate);
            startDate.setDate(startDate.getDate() + 1);
            endPicker.min(startDate);
            endPicker.value(startDate)
        }
    }

    function endChange() {
        var startPicker = $("#finicial").data("kendoDatePicker"),
            endDate = this.value();

        if (endDate) {
            endDate = new Date(endDate);
            endDate.setDate(endDate.getDate() - 1);
            startPicker.max(endDate);
        }
    }

    function cdisponibilidad(){
        var x = document.getElementsByName('X')[0].value;
        var y = document.getElementsByName('Y')[0].value;
        //var sede = document.getElementsByName('Sede')[0].value()
        $.ajax({
            url: '@Url.Action("ObtenerBungalow")',
            type: 'POST',
            datatype: "json",
            traditional: true,
            data: {
                sx: JSON.stringify(x),
                sy: JSON.stringify(y),
            },
            success: function (resultado) {
                if(resultado != ""){
                    alert("Bungalow número "+resultado.numero);
                }
            },
            error: function (event, request, settings) {
                window.alert("Ocurrió un error en su transacción");
            },
            timeout: 20000
        });
    }

    function obtenerUrlMapa(value) {
        $.ajax({
            url: '@Url.Action("ObtenerUrlImagen")',
            type: 'POST',
            datatype: "json",
            traditional: true,
            data: {
                id: JSON.stringify(value),
            },
            success: function (valor) {
                models = [];
                document.getElementById("img").src = valor;
            },
            error: function (event, request, settings) {
                models = [];
                window.alert("Ocurrió un error en su transacción");
            },
            timeout: 20000
        });
    }

    function cambioMapa(id) {
        if(id != ""){
            document.getElementsByName('Sede')[0].value = id;
            document.getElementById("img").src = obtenerUrlMapa(id);
        }else{
            document.getElementById("img").src = "../../Content/img/SeleccionarSede.png"
            document.getElementsByName('Sede')[0].value = "-1";
        }
    }

    $(document).ready(function() {
      $('img').click(function(e) {
        var offset = $(this).offset();
        document.getElementsByName('X')[0].value = e.clientX - offset.left;
        document.getElementsByName('Y')[0].value = e.clientY - offset.top;
        cdisponibilidad();
//        alert(e.clientX - offset.left);
//        alert(e.clientY - offset.top);
      });
      
      
    });


</script>

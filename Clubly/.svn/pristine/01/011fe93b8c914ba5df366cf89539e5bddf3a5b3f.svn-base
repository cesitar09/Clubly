@model Web.Models.ReservaCancha
@using Web.Models
@{
    ViewBag.Title = "Gestionar Reserva de Cancha";
}

<h1>@ViewBag.Title</h1>

<fieldset>
    <legend>Datos del Usuario</legend>
    <form id= "Form1">
        <ul>
            <li>
                <div id="editor-label">@Html.LabelFor(p => p.idFamilia)</div>
                @(Html.Kendo().AutoCompleteFor(p => p.familia.id)
                        //.Name("AutocompleteId")
                        //.BindTo("familia.id")
                        //.DataTextField("familia.id")
                        .Filter("Contiene")
                        .HighlightFirst(true)
                        .MinLength(3)
                        .HtmlAttributes(new { style = "width:155px" })
                        .DataSource(source =>
                        {
                            source.Read(read =>
                            {
                                read.Action("LeerIdFamilia", "GestionarReserva");
                            })
                            .ServerFiltering(true);
                        })
                           .Events(e => e.Close("InsertarNomUsuario"))
                )

            </li><li>
                <div id="editor-label">@Html.Label("Familia")</div>
                @Html.TextBox("nombreBox", null, new { @readonly = "readonly" })
            </li>
        </ul>
     </form>
</fieldset>

<fieldset>
    <legend>Datos de la reserva</legend>
    @using (Html.BeginForm("IngresarReservaCancha", "GestionarReserva", FormMethod.Post, new { @id = "Form2" }))
    {
        <form id="Form"><ul>
            <li>
                @Html.TextBoxFor(p => p.idFamilia, null, new { style = "display: none;" })        
            </li><li class="long">
                <div id="editor-label">@Html.LabelFor(p => p.id)</div>
                @Html.TextBoxFor(p => p.id, new { @readonly = "readonly" })
            </li><li>
                <div id="editor-label">@Html.Label("Sede")</div>
                @(Html.Kendo().DropDownListFor(p => p.idSede)
                .HtmlAttributes(new { id = "categoriaSede" })
                //.Name("categoriaSede")
                .OptionLabel("--Seleccionar--")
                .DataTextField("nombre")
                .DataValueField("id")
                .AutoBind(true)
                //.BindTo(Sede.SeleccionarTodo())
                .DataSource(source => {
                    source.Read(read =>
                    {
                        read.Action("LeerSedes", "GestionarReserva");
                    }); 
                })
                );
                
             </li><li><div id="editor-label">@Html.LabelFor(p => p.fechaInicio)</div>
                @(Html.Kendo().DatePickerFor(p => p.fechaInicio)
                .HtmlAttributes(new { style= "width:150px"})
                .Min(new DateTime(1990, 1, 1))
                .Max(new DateTime(2020, 12, 31))
                //.Value(DateTime.Today)
                .Events(e => e.Change("startChange"))
            )
            </li><li>
                <div id="editor-label">@Html.Label("Tipo de cancha")</div>
                @(//var tipo Box = //Si se usa la asignación y el render, el @ debe envolver con {} y no con ()
                    Html.Kendo().DropDownListFor(p => p.idTipoCancha)
                .HtmlAttributes(new { id = "categoriaTipo" })
                    //.Name("categoriaTipo")
                    .OptionLabel("--Seleccionar--")
                    .DataTextField("nombre")
                    .DataValueField("id")
                    //.BindTo(TipoCancha.SeleccionarTodo())
                    //tipoBox.Render();
                    .DataSource(source =>
                    {
                     source.Read(read =>
                    {
                        read.Action("LeerTipoCancha", "GestionarReserva")
                            .Data("filterSede");
                    })
                    .ServerFiltering(true);
                    })
                    .Enable(false)
                    .AutoBind(false)
                .CascadeFrom("categoriaSede")
             )
             <script>
                 function filterSede() {
                     return {
                         idSede: $("#categoriaSede").val()
                     };
                 }
            </script>
  
             </li><li><div id="editor-label">@Html.LabelFor(p => p.horaInicio)</div>
                @(Html.Kendo().TimePickerFor(p => p.horaInicio)
                .HtmlAttributes(new { style = "width:150px" })
                .Max("6:00 PM")
                .Min("8:00 AM"))

            </li><li>
                <div id="editor-label">@Html.Label("Número de cancha")</div>
                @(Html.Kendo().DropDownListFor(p => p.idCancha)
                //.Name("categoriaNumero")
                .OptionLabel("--Seleccionar--")
                .DataTextField("numero")
                .DataValueField("id")
                .AutoBind(false)
                //.BindTo(Cancha.SeleccionarTodo())   //En vez de bind debería usar DataSource
                .DataSource(source =>
                {
                  source.Read(read =>
                {
                    read.Action("LeerNumeroCancha", "GestionarReserva")
                        .Data("filterNumero");
                })
               .ServerFiltering(true);
                })
                .Enable(false)
                .AutoBind(false)
                .CascadeFrom("categoriaTipo")
                
                )
                 <script>
                     function filterNumero() {
                         return {
                             idTipo: $("#categoriaTipo").val(),
                             idSede: $("#categoriaSede").val()
                         };
                     }
                  </script>


            </li><li><div id="editor-label">@Html.LabelFor(p => p.horaFin)</div>
                @(Html.Kendo().TimePickerFor(p => p.horaFin)
                .HtmlAttributes(new { style = "width:150px" })
                .Max("6:00 PM")
                .Min("8:00 AM"))
            </li>   
        </ul>
        <div id="botones">
            <input type="button" value="Ver canchas" onclick="Javascript: AbrirPopup()"/>
            <input type="button" value="Limpiar" id="Limpiar" onclick="location.href = '@(Url.Action("GestionarReservarCancha", "GestionarReserva"))'" />
            <input type="submit" value=@(Model == null || Model.id == 0 ? "Reservar" : "Modificar") />
        </div>
        
        @if (ViewData["message"] == null)
        { }
        else if (ViewData["message"].Equals("F"))
        {<script type="text/javascript">             alert("Lo sentimos!\nNo se pudo realizar la operación.\nVuelva intentarlo en otro momento. ")</script> }
        else if (ViewData["message"].Equals("R"))
        { <script type="text/javascript">              alert("Se acaba de registrar su Entrada")</script>}
        else if (ViewData["message"].Equals("ND"))
        { <script type="text/javascript">              alert("Cancha no disponible")</script>}
        else if (ViewData["message"].Equals("NDT"))
        { <script type="text/javascript">              alert("No se encuentra ninguna Cancha Disponible, lo sentimos. Intente de nuevo")</script>} 
        else if (ViewData["message"].Equals("HNV"))
        { <script type="text/javascript">              alert("Las horas no son validad por favor ingresar correctamente")</script>}
    </form>

    }
</fieldset>

<div id="kendotable">
    @(Html.Kendo().Grid<Web.Models.ReservaCancha>()
        .Name("Grid")
        .Columns(columns =>
        {
            //columns.Bound(p => p.cancha.descripcion);
            columns.Bound(p => p.familia.id);
            columns.Bound(p => p.cancha.sede.nombre);
            columns.Bound(p=> p.cancha.numero);
            columns.Bound(p => p.fechaInicio).Format("{0:dd/MM/yyyy}");
            columns.Bound(p=>p.horaInicio).Format("{0:HH:mm}");
            columns.Bound(p => p.horaFin).Format("{0:HH:mm}");
            columns.Bound(p => p.estado);
            columns.Command(c => { c.Custom("Editar").Click("EditarPerfil"); c.Custom("Cancelar").Click("Cancelar"); });
        }
        )
        .Pageable()
        .Sortable()
        .Filterable(filterable => filterable
        .Operators(operators => operators
            .ForString(str => str.Clear()
                .Contains("Contiene")
                .StartsWith("Empezar con")
                .IsEqualTo("Es igual a")
                .IsNotEqualTo("Diferente a"))
            .ForNumber(number => number.Clear()
                .IsGreaterThan("Es mayor a")
                .IsLessThan("Es menor a")
                .IsEqualTo("Es igual a")
                .IsNotEqualTo("Es diferente a"))
        )
       )
       .DataSource(d => d.Ajax()
            .Read(r => r.Action("LeerReservasCanchas", "GestionarReserva"))
            .Events(events => events.Error("ErrorMessage"))
            .Model(m => m.Id(p => p.id))
            )
            .Selectable()
    )
</div>

<script type="text/javascript">

   
    function EditarPerfil(e) {
        e.preventDefault();
        var grid = $('#Grid').data('kendoGrid');
        var row = grid.select();
        var dataItem = grid.dataItem(row);
        var id = dataItem.id;
        location = "@Url.Action("EditarReservaCancha")" + "?id=" + id;
    }
    function Cancelar(e) {
        e.preventDefault();
        var grid = $('#Grid').data('kendoGrid');
        var row = grid.select();
        var dataItem = grid.dataItem(row);
        var id = dataItem.id;
        location = "@Url.Action("CancelarReservaCancha")" + "?id=" + id;
    }

    function InsertarNomUsuario(e) {
        var dataItem = this.value();
        document.getElementsByName('idFamilia')[0].value = dataItem;
        buscarnombre(dataItem);
    }

     function buscarnombre(value) {
        $.ajax({
            url: '@Url.Action("BuscarId")',
            type: 'POST',
            datatype: "json",
            traditional: true,
            data: {
                id: JSON.stringify(value),
            },
            success: function(persona){
                var str = persona.apPaterno + " " + persona.apMaterno
                document.getElementsByName('nombreBox')[0].value = str.toUpperCase();

            },
            error: function (event, request, settings) {
                models = [];
                window.alert("Debe ingresar una familia válido");
            },
            timeout: 20000
        });
    }
</script>


@(Html.Kendo().Window().Name("Permisos")
    .Title("Permisos del Perfil")
    .Visible(false)
    .Modal(true)
    .Draggable(true)
       
)


<script type="text/x-kendo-template" id="template2">
    <img src="../Content/img/SeleccionarSede.png"alt="Artek Alvar Aalto - Armchair 402" />
</script>

h

<script type="text/javascript">

submitForms = function(){
    document.getElementById("Form1").submit();
    document.getElementById("Form2").submit();
}


$("#Form2").validate({
        ignore: "", 
		rules: {
            horaInicio:  {
                required: true
                },
            horaFin: {
                required: true
                
                },

            },
		messages: {	
            horaInicio: {
                 required: "*Campo obligatorio"
                 
                },
            horaFin: {
                 required: "*Campo obligatorio"
                 
                },
             
		},
        submitHandler: function ConfirmationBox(form) {
        var result = confirm("¿Está seguro de realizar los cambios?");
        if (result == true) {
            form.submit();
            return true;
        }
        else {
            return false;
            }
        }
		
});

    var detailsTemplate = kendo.template($("#template2").html());
    function AbrirPopup() {
        var i = 0;
        var wnd = $("#Permisos").data('kendoWindow');
        wnd.content(detailsTemplate);

        wnd.center().open();
    }
    function ErrorMessage(e) {
        alert("A ocurrido un error en el servidor!\nVuelva a intentar la operación en unos minutos...");
    }

    function startChange() {
        startDate = this.value();

        if (startDate) {
            startDate = new Date(startDate);
            startDate.setDate(startDate.getDate() + 1);
        }
    }
</script>


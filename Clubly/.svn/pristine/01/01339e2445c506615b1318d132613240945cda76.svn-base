@model Web.Models.ReservaBungalow
@using Web.Models
@{
    ViewBag.Title = "Reserva de Bungalow";
}

<fieldset>
    <legend>Consultar disponibilidad Bungalow</legend>
    @using (Html.BeginForm("ReservaBungalow", "Reservas", FormMethod.Post, new { @id = "Form" }))
    {
        <ul class="col-one">
            <li>
                @(Html.Label("Sede"))
                @(Html.Kendo().DropDownList()
                      .Name("sede")
                      .HtmlAttributes(new { style = "width: 150px" })
                      .DataTextField("nombre")
                      .DataValueField("id") 
                      .OptionLabel("--Seleccionar--")
                      .DataSource(source =>
                      {
                          source.Read(read =>
                          {
                              read.Action("ObtenerSedes", "Reservas");
                          });
                      })
                      .Events(ev => ev.Close((@<text>
                          function(e) {
                            cambioMapa(this.value());
                          }</text>)))
            )
            @(Html.TextBox("Sede", null, new { style = "display: none;" }))
            </li><li>
                @(Html.Label("Número de Bungalow"))
                @(Html.Kendo().DropDownList()
                      .Name("id")
                      .HtmlAttributes(new { style = "width: 150px" })
                      .DataTextField("numero")
                      .DataValueField("id")
                      .OptionLabel("--Seleccionar--")
                      .DataSource(source =>
                      {
                          source.Read(read =>
                          {
                              read.Action("ObtenerBungalow", "Reservas")
                                  .Data("filtrarBungalows");
                          })
                          .ServerFiltering(true);
                      })
                      .Enable(false)
                      .AutoBind(false)
                      .CascadeFrom("sede")
                      .Events(ev => ev.Close((@<text>
                          function(e) {
                            document.getElementsByName('bungalow.id')[0].value=this.value();
                          }</text>)))
        )
            </li><li>
                @(Html.Label("Fecha Inicio"))
                @(Html.Kendo().DatePicker()
                    .Name("finicial") //The name of the datepicker is mandatory. It specifies the "id" attribute of the widget.
                    .HtmlAttributes(new { style = "width:150px" })
                    .Min(DateTime.Today) //Set min date of the datepicker
                    .Max(new DateTime(2015, 12, 31)) //Set min date of the datepicker
                    .Value(DateTime.Today) //Set the value of the datepicker
                    .Events(e => e.Change("startChange"))
                )
            </li><li>
                @(Html.Label("Fecha Final"))
                @(Html.Kendo().DatePicker()
                    .Name("ffinal") //The name of the datepicker is mandatory. It specifies the "id" attribute of the widget.
                    .HtmlAttributes(new { style = "width:150px" })
                    .Min(DateTime.Today) //Set min date of the datepicker
                    .Max(new DateTime(2015, 12, 31)) //Set min date of the datepicker
                    .Value(DateTime.Today) //Set the value of the datepicker
                    .Events(e => e.Change("endChange"))
                )
            </li><li>
                @(Html.TextBoxFor(p => p.bungalow.sede.id))
                @(Html.TextBoxFor(p => p.bungalow.id))
                
            </li>
        </ul><ul class="col-two">
            <li>
                <img id="img" src="../../Content/img/SeleccionarSede.png" width="400" height="250" />                  
            </li>
        </ul>
        <div id="botones">
            <input type="button" value="Consultar Disponibilidad" id="cdisponibilidad" onclick="Javascript: verdisponibilidad() "   />
            <input type="submit" value="Agregar" id="agregar"/>
            <input type="button" value="Limpiar" id="limpiar" onclick="Javascript: AbrirPopup() "   />
        </div>
    }
</fieldset>

 <script>
     function filtrarBungalows() {
         return {
             sede: $("#sede").val()
         };
     }
        </script>
<script>
    function startChange() {
        var endPicker = $("#ffinal").data("kendoDatePicker"),
            startDate = this.value();
        if (startDate) {
            startDate = new Date(startDate);
            startDate.setDate(startDate.getDate() + 1);
            endPicker.min(startDate);
            endPicker.value(startDate)
        }
    }

    function endChange() {
        var startPicker = $("#finicial").data("kendoDatePicker"),
            endDate = this.value();

        if (endDate) {
            endDate = new Date(endDate);
            endDate.setDate(endDate.getDate() - 1);
            startPicker.max(endDate);
        }
    }

    function verdisponibilidad(){
        var idBungalow = document.getElementsByName('bungalow.id')[0].value;
        var finicial = $('#finicial').val();
        var ffinal = $('#ffinal').val();
        $.ajax({
            url: '@Url.Action("VerDisponibilidad")',
            type: 'POST',
            datatype: "json",
            traditional: true,
            data: {
                sidBungalow: JSON.stringify(idBungalow),
                sfinicial: JSON.stringify(finicial),
                sffinal:  JSON.stringify(ffinal),
            },
            success: function (resultado) {
                if(resultado != ""){
                    
                }
            },
            error: function (event, request, settings) {
                window.alert("Ocurrió un error en su transacción");
            }
            //timeout: 20000
        });
    }

    function obtenerUrlMapa(value) {
        $.ajax({
            url: '@Url.Action("ObtenerUrlImagen")',
            type: 'POST',
            datatype: "json",
            traditional: true,
            data: {
                id: JSON.stringify(value),
            },
            success: function (valor) {
                models = [];
                document.getElementById("img").src = valor;
            },
            error: function (event, request, settings) {
                models = [];
                window.alert("Ocurrió un error en su transacción");
            },
            timeout: 20000
        });
    }

    function cambioMapa(id) {
        if(id != ""){
            document.getElementsByName('Sede')[0].value = id;
            document.getElementById("img").src = obtenerUrlMapa(id);
            document.getElementsByName('bungalow.sede.id')[0].value=id;
        }else{
            document.getElementById("img").src = "../../Content/img/SeleccionarSede.png"
            document.getElementsByName('Sede')[0].value = "-1";
        }
    }





</script>
